{% extends 'app/base.html' %}

{% block script %}
  <style>
      @media print {
          .print-halfpage {
              display: flex;
              flex: 0 0 33%;
              max-width: 33%;
          }

          .card {
              width: 100%;
          }
      }

      .highlighted {
          background-color: yellow !important;
          font-weight: bold;
      }
  </style>

  <script>
      let stu;

      $(function () {
          $(".movehere").hide();
      })

      function move_student(student_id) {
          stu = student_id;

          $("#person-" + stu).addClass("highlighted");

          $(".move").hide();
          $(".movehere").show();
      }

      function move_to(room_id) {
          table_id = room_id.replaceAll(" ", "")
          $("#person-" + stu).removeClass("highlighted")

          $(".move").show();
          $(".movehere").hide();

          $.post("{% url 'admin_move_student' %}", {
              "solution": "{{ solution.id }}",
              "person": stu,
              "to": room_id
          }).then(function (data) {
              $("#person-" + stu).detach().appendTo("#table-" + table_id)
              $("#explanation").html(data['explanation'])
          })


      }

      function show_modal(student_id) {
          $('#modal-title').html("Loading...")
          $("#modal-body").html("")

          $("#modal").modal()

          $.get("{% url 'admin_get_stats' %}", {"id": student_id, "solution": {{solution.id}}})
              .then(function (data) {
                  $("#modal-title").html(data['name'])

                  $("#modal-body").html("<table class='table table-striped table-hover' id='modal-table'></table>")

                  data['requests'].forEach(function (item) {
                      $("#modal-table").append(`<tr><td>${item['name']}</td><td>${item['satisfied']}</td></tr>`)
                  })
              })
      }
  </script>
{% endblock %}

{% block content %}
  <div class="row">
    <div class="col-12 d-print-none">
      <div class="jumbotron">
        <h1>Edit Rooms List</h1>
        <h4>{{ solution.name }}</h4>
        <p id="explanation">{{ solution.explanation | linebreaksbr }}</p>
      </div>
    </div>

    {% for room, people in rooms.items %}
      <div class="col-12 col-md-6 col-lg-4 print-halfpage">
        <div class="card mb-3">
          <div class="card-body">
            <h2 class="card-title">{{ room }}</h2>
            <table class="table table-striped table-hover" id="table-{{ room|cut:' ' }}">
              <tbody>
              {% for person in people %}
                <tr id="person-{{ person.id }}">
                  <td><a class="text-secondary" href="#"
                         onclick="show_modal({{ person.id }}); return false;">{{ person.name }}</a></td>
                  <td class="d-print-none">
                    <a href="#" class="move" onclick="move_student({{ person.id }}); return false;">Move</a>
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
            <div class="text-center">
              <a href="#" class="btn btn-primary text-white movehere" style="display: none"
                 onclick="move_to('{{ room }}'); return false;">Move Here</a>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="modal" tabindex="-1" role="dialog" id="modal">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modal-title">Modal title</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body" id="modal-body">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}